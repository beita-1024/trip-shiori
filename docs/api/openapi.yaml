openapi: 3.0.3
info:
  title: Trip Shiori API
  description: |
    旅のしおり作成・管理システムのAPI
    
    このAPIは旅行の行程を作成・編集・管理するためのRESTful APIです。
    AI機能を使用してイベントの補完や旅程の編集をサポートします。
    
    ## 認証
    - JWT認証を使用（HttpOnly Cookie）
    - メール認証が必要
    - パスワードリセット機能あり
    
    ## レート制限
    - パスワードリセット: 15分あたり3回
    - パスワードリセット確認: 15分あたり5回
    
  version: 1.0.0
  contact:
    name: Trip Shiori Team
  license:
    name: MIT

servers:
  - url: http://localhost:4002
    description: 開発環境
  - url: https://xxxxxx.com
    description: 本番環境

paths:
  /health:
    get:
      summary: ヘルスチェック
      description: サーバーの稼働状況を確認
      tags:
        - System
      responses:
        '200':
          description: サーバー正常稼働
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true

  /auth/register:
    post:
      summary: ユーザー登録
      description: 新しいユーザーアカウントを作成し、メール認証を送信
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  minLength: 8
                  pattern: '^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).*$'
                  description: 8文字以上、大文字・小文字・数字・特殊文字を含む
                  example: SecurePass123!
                name:
                  type: string
                  description: 表示名（任意）
                  example: 田中太郎
      responses:
        '204':
          description: 登録成功（メール送信完了）
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '409':
          description: メールアドレス重複
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/verify-email:
    get:
      summary: メール認証
      description: メール認証トークンを検証し、ユーザーを認証済みに更新
      tags:
        - Authentication
      parameters:
        - name: uid
          in: query
          required: true
          schema:
            type: string
          description: ユーザーID
        - name: token
          in: query
          required: true
          schema:
            type: string
          description: 認証トークン
      responses:
        '302':
          description: 認証成功（ダッシュボードへリダイレクト、JWT Cookie設定）
          headers:
            Location:
              description: リダイレクト先URL
              schema:
                type: string
            Set-Cookie:
              description: JWT Cookie
              schema:
                type: string
        '400':
          description: 無効・期限切れトークン
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      summary: ユーザーログイン
      description: メールアドレスとパスワードでログインし、JWT Cookieを発行
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  example: SecurePass123!
      responses:
        '204':
          description: ログイン成功（HttpOnly CookieでJWT発行）
          headers:
            Set-Cookie:
              description: JWT Cookie
              schema:
                type: string
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: 認証失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: メール未認証
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      summary: ユーザーログアウト
      description: 認証済みユーザーをログアウトし、JWT Cookieを無効化
      tags:
        - Authentication
      security:
        - cookieAuth: []
      responses:
        '204':
          description: ログアウト成功（Cookie無効化）
          headers:
            Clear-Cookie:
              description: Cookie無効化
              schema:
                type: string
        '401':
          description: 未認証
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/protected:
    get:
      summary: 保護されたリソース
      description: 認証済みユーザーのみアクセス可能なリソースの例
      tags:
        - Authentication
      security:
        - cookieAuth: []
      responses:
        '200':
          description: 認証済みユーザー情報
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                        example: user123
                      email:
                        type: string
                        example: user@example.com
                  message:
                    type: string
                    example: This is a protected resource
        '401':
          description: 未認証
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/password-reset/request:
    post:
      summary: パスワードリセットリクエスト
      description: メールアドレスを受け取り、パスワードリセットトークンを発行してメール送信
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        '204':
          description: リクエスト受付完了（存在不問で同一応答）
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          description: レート制限超過
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/password-reset/confirm:
    post:
      summary: パスワードリセット確認
      description: パスワードリセットトークンを検証し、新しいパスワードを設定
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - uid
                - token
                - newPassword
              properties:
                uid:
                  type: string
                  example: user123
                token:
                  type: string
                  example: abc123...
                newPassword:
                  type: string
                  minLength: 8
                  pattern: '^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).*$'
                  description: 8文字以上、大文字・小文字・数字・特殊文字を含む
                  example: NewSecurePass123!
      responses:
        '204':
          description: パスワードリセット成功
        '400':
          description: バリデーションエラーまたは無効・期限切れトークン
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          description: レート制限超過
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/itineraries:
    post:
      summary: 旅のしおり作成
      description: 新しい旅のしおりを作成
      tags:
        - Itineraries
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Itinerary'
      responses:
        '201':
          description: 旅のしおり作成成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    example: abc123def456
        '422':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: array
                    items:
                      type: string
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: array
                    items:
                      type: string

    get:
      summary: 全旅のしおり取得
      description: 全ての旅のしおりを取得
      tags:
        - Itineraries
      responses:
        '200':
          description: 旅のしおり一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ItineraryRecord'

  /api/itineraries/{id}:
    get:
      summary: 旅のしおり取得
      description: 指定されたIDの旅のしおりを取得
      tags:
        - Itineraries
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: 旅のしおりID
      responses:
        '200':
          description: 旅のしおりデータ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Itinerary'
        '404':
          description: 旅のしおりが見つからない
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Itinerary not found
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Internal server error

  /api/events/complete:
    post:
      summary: イベント補完
      description: 2つのイベントの間に新しいイベントを生成するAI機能
      tags:
        - Events
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - event1
                - event2
              properties:
                event1:
                  $ref: '#/components/schemas/Event'
                event2:
                  $ref: '#/components/schemas/Event'
                dummy:
                  type: boolean
                  description: ダミーモードフラグ（オプション）
                  example: false
      parameters:
        - name: x-user-id
          in: header
          required: false
          schema:
            type: string
          description: ユーザーID（オプション）
      responses:
        '200':
          description: 生成されたイベント
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '400':
          description: 必須フィールド不足
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: event1 and event2 are required in body
        '422':
          description: AI生成エラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: AI generation failed

  /api/itinerary-edit:
    post:
      summary: 旅程編集
      description: AIを使用して旅程を編集
      tags:
        - Itinerary Edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - originalItinerary
                - editPrompt
              properties:
                originalItinerary:
                  $ref: '#/components/schemas/Itinerary'
                editPrompt:
                  type: string
                  description: 変更したい内容の説明
                  example: 2日目の朝食を和食に変更してください
      responses:
        '200':
          description: 旅程編集成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/ItineraryEditResponse'
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: originalItinerary is required
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: Internal server error

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: access_token
      description: JWT認証トークン（HttpOnly Cookie）

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          example: unauthorized
        message:
          type: string
          example: Invalid credentials

    ValidationError:
      type: object
      properties:
        error:
          type: string
          example: invalid_body
        message:
          type: string
          example: Validation failed
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
                example: email
              message:
                type: string
                example: Invalid email format

    Event:
      type: object
      required:
        - time
        - end_time
        - title
        - description
        - icon
      properties:
        time:
          type: string
          pattern: '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$'
          description: 開始時刻（HH:MM形式）
          example: "10:00"
        end_time:
          type: string
          pattern: '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$'
          description: 終了時刻（HH:MM形式）
          example: "11:30"
        title:
          type: string
          description: イベントタイトル
          example: "出発"
        description:
          type: string
          description: イベントの詳細説明
          example: "新宿駅から電車で移動"
        icon:
          type: string
          enum:
            - "mdi-map-marker"
            - "mdi-walk"
            - "mdi-train"
            - "mdi-bike"
            - "mdi-bus"
            - "mdi-airplane"
            - "mdi-camera"
            - "mdi-food"
            - "mdi-car"
          description: アイコン名
          example: "mdi-train"

    Day:
      type: object
      required:
        - events
      properties:
        date:
          type: string
          format: date
          description: 日付（オプション）
          example: "2025-09-01"
        events:
          type: array
          items:
            $ref: '#/components/schemas/Event'
          description: その日のイベント一覧

    Itinerary:
      type: object
      required:
        - title
        - days
      properties:
        title:
          type: string
          description: 旅程タイトル
          example: "東京観光旅行"
        subtitle:
          type: string
          description: サブタイトル（オプション）
          example: "3日間の東京観光"
        description:
          type: string
          description: 旅程の説明（オプション）
          example: "初めての東京旅行で主要観光地を巡ります"
        days:
          type: array
          items:
            $ref: '#/components/schemas/Day'
          description: 日程一覧

    ItineraryRecord:
      type: object
      properties:
        id:
          type: string
          example: abc123def456
        data:
          type: string
          description: 旅程データ（JSON文字列）
        createdAt:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"
        userId:
          type: string
          nullable: true
          example: user123

    ItineraryEditResponse:
      type: object
      required:
        - modifiedItinerary
        - diffPatch
        - changeDescription
      properties:
        modifiedItinerary:
          $ref: '#/components/schemas/Itinerary'
        diffPatch:
          type: object
          description: 旅程の差分（JSON patch）
        changeDescription:
          type: string
          description: 変更内容の自然言語説明
          example: "2日目の朝食を和食レストランに変更しました"

tags:
  - name: System
    description: システム関連
  - name: Authentication
    description: 認証・認可
  - name: Itineraries
    description: 旅のしおり管理
  - name: Events
    description: イベント管理
  - name: Itinerary Edit
    description: 旅程編集
