openapi: 3.1.0
info:
  title: Trip Shiori API
  description: |
    旅のしおり作成・管理システムのAPI
    
    このAPIは旅行の行程を作成・編集・管理するためのRESTful APIです。
    OpenAI ChatGPT APIを統合したAI機能により、イベントの補完や旅程の編集をサポートします。
    
    ## AI機能について
    このAPIでは以下のAI機能を提供しています：
    - **イベント補完**: 2つのイベントの間に新しいイベントを自動生成
    - **旅程編集**: 自然言語での編集指示を理解し、旅程を自動更新
    
    **AI構成**:
    - **LLMプロバイダー**: Cerebras API（gpt-oss-120b）優先、OpenAI API（gpt-4o-mini）フォールバック
    - **RAG機能**: Tavily Search API（最大3回/実行）
    - **内部通信**: FastAPI（Python）+ LangChain 0.3 + LangGraph
    - **タイムアウト**: 60秒、リトライ機能付き
    
    詳細については、[AI統合ドキュメント](../ai-integration.md)を参照してください。
    
    
    ## グローバルミドルウェア
    以下のミドルウェアは全エンドポイントで自動的に適用されます：
    - **CORS**: クロスオリジンリクエストの制御（ブラウザの同一オリジンポリシー対応）
    - **express.json**: JSONリクエストボディの解析
    - **cookieParser**: Cookieの解析（JWT認証用）
    
    ## ミドルウェア一覧
    このAPIでは以下のミドルウェアを使用しています：
    
    ### auth（JWT認証）
    - **処理内容**: JWTトークンの検証とユーザー認証
    - **適用範囲**: 認証が必要なエンドポイント
    - **目的**: セキュリティ確保とユーザー識別
    
    ### checkItineraryOwnership（旅程所有権チェック）
    - **処理内容**: 認証済みユーザーが指定された旅程の所有者かどうかをチェック
    - **適用範囲**: 旅程の所有権が必要なエンドポイント
    - **目的**: 所有者以外のアクセスを防止し、セキュリティを強化
    
    ### rateLimit（レート制限）
    - **処理内容**: リクエスト頻度の制限
    -         **制限値**:
      - 一般エンドポイント: 60 req/min
      - パスワードリセット: 15分あたり3回
      - パスワードリセット確認: 15分あたり5回
      - AI機能: 30 req/min（内部FastAPI経由）
    - **目的**: サーバー負荷軽減とセキュリティ向上
    
    ### validation（バリデーション）
    - **処理内容**: Zodスキーマを使用したリクエストデータの検証
    - **適用範囲**: リクエストボディ・クエリパラメータ・パスパラメータ
    - **目的**: 型安全性確保とデータ整合性チェック
    
    ### CORS（Cross-Origin Resource Sharing）
    - **処理内容**: クロスオリジンリクエストの制御
    - **適用範囲**: 全エンドポイント（グローバル設定）
    - **目的**: ブラウザの同一オリジンポリシー対応とセキュリティ
    
    ### express.json（JSONパーサー）
    - **処理内容**: JSONリクエストボディの解析
    - **適用範囲**: 全エンドポイント（グローバル設定）
    - **目的**: リクエストボディの解析
    
    ### cookieParser（Cookieパーサー）
    - **処理内容**: Cookieの解析
    - **適用範囲**: 全エンドポイント（グローバル設定）
    - **目的**: JWT認証用のCookie処理
    
  version: 1.0.0
  contact:
    name: Trip Shiori Team
  license:
    name: None

servers:
  - url: http://localhost:4002
    description: 開発環境
  - url: https://xxxxxx.com
    description: 本番環境

paths:
  /health:
    get:
      summary: ヘルスチェック
      description: サーバーの稼働状況を確認
      tags:
        - System
      responses:
        '200':
          description: サーバー正常稼働
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true

  /auth/register:
    post:
      summary: ユーザー登録
      description: 新しいユーザーアカウントを作成し、メール認証を送信
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  minLength: 8
                  maxLength: 1024
                  pattern: '^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).*$'
                  description: 8文字以上1024文字以下、大文字・小文字・数字・特殊文字を含む
                  example: SecurePass123!
                name:
                  type: string
                  description: 表示名（任意）
                  example: 田中太郎
      responses:
        '204':
          description: 登録成功（メール送信完了）
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '409':
          description: メールアドレス重複
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/verify-email:
    get:
      summary: メール認証
      description: |
        メール認証トークンを検証し、ユーザーを認証済みに更新
        
        **処理内容**:
        - メール認証トークンの検証
        - ユーザーを認証済み状態に更新
        - Access Token + Refresh TokenをCookieで発行（自動ログイン）
        
        **発行されるトークン**:
        - Access Token: 15分間有効（httpOnly Cookie）
        - Refresh Token: 7日間有効（httpOnly Cookie）
      tags:
        - Authentication
      parameters:
        - name: uid
          in: query
          required: true
          schema:
            type: string
          description: ユーザーID
        - name: token
          in: query
          required: true
          schema:
            type: string
          description: 認証トークン
      responses:
        '200':
          description: 認証成功（JWT Cookie設定、JSON本文）
          headers:
            Set-Cookie:
              description: JWT Cookie
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Email verification successful"
        '400':
          description: 無効・期限切れトークン
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      summary: ユーザーログイン
      description: |
        メールアドレスとパスワードでログインし、Access Token + Refresh TokenをCookieで発行
        
        **発行されるトークン**:
        - Access Token: 15分間有効（httpOnly Cookie）
        - Refresh Token: 7日間有効（httpOnly Cookie）
        
        **セキュリティ機能**:
        - httpOnly Cookie: XSS攻撃からの保護
        - Refresh Token Rotation: セキュリティ向上
        - デバイス情報記録: User-Agent等を記録
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  minLength: 1
                  maxLength: 1024
                  description: パスワード（ログイン時は強度チェックなし）
                  example: SecurePass123!
      responses:
        '204':
          description: ログイン成功（Access Token + Refresh TokenをhttpOnly Cookieで発行）
          headers:
            Set-Cookie:
              description: トークンCookie
              schema:
                type: string
              example: access_token=<JWT>; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=900
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: 認証失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: メール未認証
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      summary: ユーザーログアウト
      description: |
        認証済みユーザーをログアウトし、全Tokenを無効化
        
        **処理内容**:
        - ユーザーの全Refresh Tokenを失効
        - Access Token Cookieをクリア
        - Refresh Token Cookieをクリア
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
      tags:
        - Authentication
      security:
        - cookieAuth: []
      responses:
        '204':
          description: ログアウト成功（全Token無効化・Cookieクリア）
          headers:
            Set-Cookie:
              description: トークンCookieを削除するためのSet-Cookieヘッダー
              schema:
                type: string
              examples:
                accessToken:
                  summary: access_tokenの削除
                  value: access_token=; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=0
                refreshToken:
                  summary: refresh_tokenの削除
                  value: refresh_token=; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=0
        '401':
          description: 未認証
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/refresh:
    post:
      summary: Refresh Token更新
      description: |
        Refresh Tokenを使用して新しいAccess TokenとRefresh Tokenを発行（Refresh Token Rotation）
        
        **セキュリティ機能**:
        - Refresh Token Rotation: 使用済みトークンは即座に失効
        - レート制限: 1分間に10回まで
        - デバイス情報記録: User-Agent等を記録してセキュリティ監視
        
        **使用ミドルウェア**:
        - rateLimit: リクエスト頻度制限（1分間に10回）
      tags:
        - Authentication
      security: []
      responses:
        '204':
          description: トークン更新成功（新しいAccess Token + Refresh TokenをCookieで発行）
          headers:
            Set-Cookie:
              description: 新しいトークンをhttpOnly Cookieで設定
              schema:
                type: string
                example: access_token=<new_JWT>; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=900
            Cache-Control:
              description: キャッシュ制御（トークンはキャッシュ不可）
              schema:
                type: string
                example: no-store
            Vary:
              description: Cookieによる応答の変動を示す
              schema:
                type: string
                example: Cookie
        '401':
          description: 認証失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                unauthorized:
                  summary: Refresh Token無効
                  value:
                    error: 'unauthorized'
                    message: 'Invalid or expired refresh token'
                token_required:
                  summary: Refresh Token未提供
                  value:
                    error: 'unauthorized'
                    message: 'Refresh token required'
                password_changed:
                  summary: パスワード変更によるToken無効化
                  value:
                    error: 'unauthorized'
                    message: 'Token invalidated due to password change'
        '429':
          description: レート制限超過
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: 'rate_limit_exceeded'
                message: 'Too many refresh token requests. Please try again later.'
                retryAfter: 60
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/protected:
    get:
      summary: 保護されたリソース
      description: |
        認証済みユーザーのみアクセス可能なリソースの例
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
      tags:
        - Authentication
      security:
        - cookieAuth: []
      responses:
        '200':
          description: 認証済みユーザー情報
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                        example: user123
                      email:
                        type: string
                        example: user@example.com
                  message:
                    type: string
                    example: This is a protected resource
                  tokenExp:
                    type: number
                    description: アクセストークンの有効期限（Unix timestamp、秒単位）
                    example: 1704067200
        '401':
          description: 未認証
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/password-reset/request:
    post:
      summary: パスワードリセットリクエスト
      description: |
        メールアドレスを受け取り、パスワードリセットトークンを発行してメール送信
        
        **使用ミドルウェア**:
        - rateLimit: レート制限（15分あたり3回）- スパム防止とセキュリティ向上のため
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        '204':
          description: リクエスト受付完了（存在不問で同一応答）
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          description: レート制限超過
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/password-reset/confirm:
    post:
      summary: パスワードリセット確認
      description: |
        パスワードリセットトークンを検証し、新しいパスワードを設定
        
        **使用ミドルウェア**:
        - rateLimit: レート制限（15分あたり5回）- ブルートフォース攻撃防止のため
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - uid
                - token
                - newPassword
              properties:
                uid:
                  type: string
                  example: user123
                token:
                  type: string
                  example: abc123...
                newPassword:
                  type: string
                  minLength: 8
                  maxLength: 1024
                  pattern: '^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).*$'
                  description: 8文字以上1024文字以下、大文字・小文字・数字・特殊文字を含む
                  example: NewSecurePass123!
      responses:
        '204':
          description: パスワードリセット成功
        '400':
          description: バリデーションエラーまたは無効・期限切れトークン
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          description: レート制限超過
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ユーザー管理API

  /api/users/profile:
    get:
      summary: ユーザープロフィール取得
      description: |
        認証済みユーザーのプロフィール情報を取得
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
      tags:
        - Users
      security:
        - cookieAuth: []
      responses:
        '200':
          description: ユーザープロフィール情報
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      summary: ユーザープロフィール更新
      description: |
        認証済みユーザーのプロフィール情報を更新
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Users
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  maxLength: 255
                  example: "New Name"
      responses:
        '200':
          description: 更新されたユーザープロフィール情報
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/users/password:
    put:
      summary: パスワード変更
      description: |
        認証済みユーザーのパスワードを変更
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Users
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - currentPassword
                - newPassword
              properties:
                currentPassword:
                  type: string
                  minLength: 1
                  description: 現在のパスワード（既存ユーザーの弱いパスワード対応のため強度チェックなし）
                  example: "currentpass"
                newPassword:
                  type: string
                  minLength: 8
                  maxLength: 1024
                  pattern: '^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).*$'
                  description: 8文字以上1024文字以下、大文字・小文字・数字・特殊文字を含む
                  example: "NewSecurePass123!"
      responses:
        '204':
          description: パスワードが正常に変更されました
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/users/account/delete:
    post:
      summary: アカウント削除
      description: |
        認証済みユーザーのアカウントを削除（パスワード確認必須）
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Users
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - password
              properties:
                password:
                  type: string
                  minLength: 1
                  maxLength: 1024
                  description: 現在のパスワード（アカウント削除確認用、強度チェックなし）
                  example: "UserPass123!"
      responses:
        '204':
          description: アカウントが正常に削除されました
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # 旅程管理CRUD API
  /api/itineraries:
    get:
      summary: 旅程一覧取得
      description: |
        認証済みユーザーの旅程一覧を取得（ページネーション対応）
        
        共有機能のクエリパラメータにより、以下の絞り込みが可能です：
        - shareScope: 共有範囲での絞り込み（単一または複数指定可能）
        - sharePermission: 共有権限での絞り込み（単一または複数指定可能）
        - includeShare: 各旅程の共有設定情報を含めるか
        - includeShared: 共有された旅程も含めるか
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
        - validation: クエリパラメータのバリデーション（Zodスキーマ）
      tags:
        - Itineraries
      security:
        - cookieAuth: []
      parameters:
        - name: page
          in: query
          description: ページ番号（1から開始）
          required: true
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: 1ページあたりの件数（最大100）
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: sort
          in: query
          description: ソートフィールド
          required: true
          schema:
            type: string
            enum: [createdAt, updatedAt]
            default: createdAt
        - name: order
          in: query
          description: ソート順序
          required: true
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: shareScope
          in: query
          description: 共有範囲での絞り込み（単一または複数指定可能）
          required: true
          schema:
            oneOf:
              - type: string
                enum: [PRIVATE, PUBLIC_LINK, PUBLIC]
              - type: array
                items:
                  type: string
                  enum: [PRIVATE, PUBLIC_LINK, PUBLIC]
          example: "PUBLIC_LINK"
        - name: sharePermission
          in: query
          description: 共有権限での絞り込み（単一または複数指定可能）
          required: true
          schema:
            oneOf:
              - type: string
                enum: [READ_ONLY, EDIT]
              - type: array
                items:
                  type: string
                  enum: [READ_ONLY, EDIT]
          example: "READ_ONLY"
        - name: includeShare
          in: query
          description: 各旅程の共有設定情報を含めるか
          required: true
          schema:
            type: boolean
            default: false
        - name: includeShared
          in: query
          description: 共有された旅程も含めるか
          required: true
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: 旅程一覧とページネーション情報
          content:
            application/json:
              schema:
                type: object
                properties:
                  itineraries:
                    type: array
                    items:
                      $ref: '#/components/schemas/ItineraryListItem'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      summary: 旅程作成
      description: |
        認証済みユーザーが新しい旅程を作成
        
        **自動設定**:
        - 旅程作成時に自動的にデフォルト共有設定が作成されます
        - デフォルト設定: EDIT権限、PRIVATE公開範囲
        - パスワード保護なし、有効期限なし（後で変更可能）
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Itineraries
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: 旅程データ（任意のJSON形式）
              example:
                title: "Tokyo Trip"
                start_date: "2025-09-01"
                end_date: "2025-09-05"
                days: []
      responses:
        '201':
          description: 旅程が正常に作成されました
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    example: "itn_123"
                  message:
                    type: string
                    example: "Itinerary created successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/itineraries/{id}:
    get:
      summary: 旅程詳細取得
      description: |
        認証済みユーザーが自分の旅程を取得、または共有設定によりアクセス可能な旅程を取得
        
        **アクセス制御**:
        1. **所有者**: 旅程の作成者は常にアクセス可能
        2. **共有設定がある場合**: 公開範囲（scope）に応じて以下のアクセス制御が行われます：
           - PRIVATE: 所有者のみアクセス可能（デフォルト）
           - PUBLIC_LINK: リンクを知っている人全員（認証不要）
           - PUBLIC: 全体公開（認証不要）
        3. **共有設定がない場合**: 所有者のみアクセス可能
        
        **セキュリティ機能**:
        - 有効期限チェック: 期限切れの共有設定は自動的に無効化
        - パスワード保護: 共有設定でパスワードが設定されている場合は認証が必要
        
        **使用ミドルウェア**:
        - auth: JWT検証（共有設定がある場合は認証不要）
        - rateLimit: リクエスト頻度制限（60 req/min）
      tags:
        - Itineraries
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      responses:
        '200':
          description: 旅程データ（JSON形式）
          content:
            application/json:
              schema:
                type: object
                description: 旅程データ（任意のJSON形式）
                example:
                  title: "Tokyo Trip"
                  start_date: "2025-09-01"
                  end_date: "2025-09-05"
                  days: []
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      summary: 旅程更新
      description: |
        認証済みユーザーが自分の旅程を更新
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Itineraries
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: 更新する旅程データ
              example:
                title: "Updated Tokyo Trip"
                start_date: "2025-09-01"
                end_date: "2025-09-05"
                days: []
      responses:
        '200':
          description: 旅程が正常に更新されました
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Itinerary updated successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      summary: 旅程削除
      description: |
        認証済みユーザーが自分の旅程を削除
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
      tags:
        - Itineraries
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      responses:
        '204':
          description: 旅程が正常に削除されました
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # 旅程共有機能API
  /api/itineraries/{id}/share:
    post:
      summary: 共有設定作成
      description: |
        旅程の所有者が共有設定を作成
        
        旅程IDベースの共有URLを生成し、権限レベル、パスワード保護、有効期限の設定を可能にします。
        旅程の所有者のみが共有設定を作成でき、セキュリティを確保します。
        
        **使用ミドルウェア**:
        - auth: JWT認証（Cookie: access_token）
        - checkItineraryOwnership: 旅程所有権チェック（所有者のみアクセス可能）
        - rateLimit: リクエスト頻度制限（30 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Itinerary Share
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - permission
                - scope
              properties:
                permission:
                  type: string
                  enum: [READ_ONLY, EDIT]
                  description: 共有権限レベル
                  example: "READ_ONLY"
                password:
                  type: string
                  minLength: 8
                  maxLength: 128
                  description: 共有パスワード（オプション）
                  example: "SharePass123!"
                expiresAt:
                  type: string
                  format: date-time
                  description: 有効期限（ISO 8601形式、オプション）
                  example: "2024-12-31T23:59:59Z"
                scope:
                  type: string
                  enum: [PRIVATE, PUBLIC_LINK, PUBLIC]
                  description: 公開範囲
                  example: "PUBLIC_LINK"
      responses:
        '201':
          description: 共有設定が正常に作成されました
          content:
            application/json:
              schema:
                type: object
                properties:
                  shareUrl:
                    type: string
                    description: 共有URL
                    example: "https://example.com/shared/itn_123"
                  message:
                    type: string
                    example: "Share settings created successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: アクセス拒否（所有者以外）
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "forbidden"
                  message:
                    type: string
                    example: "Only the owner can create share settings"
        '404':
          description: 旅程が見つかりません
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "itinerary_not_found"
                  message:
                    type: string
                    example: "Itinerary not found"
        '409':
          description: 既に共有設定が存在します
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "share_already_exists"
                  message:
                    type: string
                    example: "Share settings already exist for this itinerary"
        '500':
          $ref: '#/components/responses/InternalServerError'

    get:
      summary: 共有設定取得
      description: |
        旅程の共有設定を取得（認証不要）
        
        **使用ミドルウェア**:
        - rateLimit: リクエスト頻度制限（30 req/min）
      tags:
        - Itinerary Share
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      responses:
        '200':
          description: 共有設定情報
          content:
            application/json:
              schema:
                type: object
                properties:
                  permission:
                    type: string
                    enum: [READ_ONLY, EDIT]
                    description: 共有権限レベル
                    example: "READ_ONLY"
                  hasPassword:
                    type: boolean
                    description: パスワード保護の有無
                    example: true
                  expiresAt:
                    type: [string, "null"]
                    format: date-time
                    description: 有効期限（nullの場合は無期限）
                    example: "2024-12-31T23:59:59Z"
                  scope:
                    type: string
                    enum: [PRIVATE, PUBLIC_LINK, PUBLIC]
                    description: 公開範囲
                    example: "PRIVATE"
        '404':
          description: 共有設定が見つかりません
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "share_not_found"
                  message:
                    type: string
                    example: "Share settings not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      summary: 共有設定更新
      description: |
        旅程の所有者が共有設定を更新（部分更新対応）
        
        **使用ミドルウェア**:
        - auth: JWT認証（Cookie: access_token）
        - checkItineraryOwnership: 旅程所有権チェック（所有者のみアクセス可能）
        - rateLimit: リクエスト頻度制限（30 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Itinerary Share
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                permission:
                  type: string
                  enum: [READ_ONLY, EDIT]
                  description: 共有権限レベル
                  example: "EDIT"
                password:
                  type: [string, "null"]
                  minLength: 8
                  maxLength: 128
                  description: 共有パスワード（nullでパスワード削除）
                  example: "NewSharePass123!"
                expiresAt:
                  type: [string, "null"]
                  format: date-time
                  description: 有効期限（nullで無期限）
                  example: "2024-12-31T23:59:59Z"
                scope:
                  type: string
                  enum: [PRIVATE, PUBLIC_LINK, PUBLIC]
                  description: 公開範囲
                  example: "PUBLIC_LINK"
      responses:
        '200':
          description: 共有設定が正常に更新されました
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Share settings updated successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: 共有設定が見つかりません
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "share_not_found"
                  message:
                    type: string
                    example: "Share settings not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      summary: 共有設定削除
      description: |
        旅程の所有者が共有設定を削除
        
        **使用ミドルウェア**:
        - auth: JWT認証（Cookie: access_token）
        - checkItineraryOwnership: 旅程所有権チェック（所有者のみアクセス可能）
        - rateLimit: リクエスト頻度制限（30 req/min）
      tags:
        - Itinerary Share
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      responses:
        '204':
          description: 共有設定が正常に削除されました
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: アクセス拒否（所有者以外）
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "forbidden"
                  message:
                    type: string
                    example: "Only the owner can delete share settings"
        '404':
          description: 共有設定が見つかりません
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "share_not_found"
                  message:
                    type: string
                    example: "Share settings not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

  # 公開旅程アクセスAPI
  /shared/{id}:
    get:
      summary: 共有リンク経由で旅程取得
      description: |
        リンクを知っている全員がアクセス可能な旅程を取得
        
        **アクセス制御**:
        - PUBLIC_LINK公開範囲の旅程のみアクセス可能
        - 認証不要
        - 有効期限チェックあり
        - アクセス回数の自動カウント
        
        **使用ミドルウェア**:
        - rateLimit: リクエスト頻度制限（120 req/min）
      tags:
        - Public Access
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      responses:
        '200':
          description: 旅程データ（JSON形式）+ 共有情報
          content:
            application/json:
              schema:
                type: object
                properties:
                  title:
                    type: string
                    example: "Tokyo Trip"
                  start_date:
                    type: string
                    example: "2025-09-01"
                  end_date:
                    type: string
                    example: "2025-09-05"
                  days:
                    type: array
                    items:
                      type: object
                  _shareInfo:
                    type: object
                    properties:
                      permission:
                        type: string
                        enum: [READ_ONLY, EDIT]
                        example: "READ_ONLY"
                      scope:
                        type: string
                        enum: [PUBLIC_LINK]
                        example: "PUBLIC_LINK"
                      isReadOnly:
                        type: boolean
                        example: true
                      accessCount:
                        type: integer
                        example: 5
                      lastAccessedAt:
                        type: string
                        format: date-time
                        example: "2025-01-15T10:30:00Z"
        '403':
          description: アクセス拒否
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 旅程が見つかりません
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: 共有期限切れ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /public/{id}:
    get:
      summary: 公開旅程取得（OGP対応）
      description: |
        誰でもアクセス可能な公開旅程を取得（検索エンジンにインデックスされる）

        注意: 要件調整中のため本エンドポイントは一時停止中です。`PUBLIC_SHARING_ENABLED=true` で再開可能。フラグOFF時は 404 を返します。
        
        **アクセス制御**:
        - PUBLIC公開範囲の旅程のみアクセス可能
        - 認証不要
        - OGP用メタデータを含む
        - アクセス回数の自動カウント
        
        **使用ミドルウェア**:
        - rateLimit: リクエスト頻度制限（120 req/min）
      tags:
        - Public Access
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      responses:
        '200':
          description: 旅程データ（JSON形式）+ OGP用メタデータ
          content:
            application/json:
              schema:
                type: object
                properties:
                  title:
                    type: string
                    example: "Tokyo Trip"
                  start_date:
                    type: string
                    example: "2025-09-01"
                  end_date:
                    type: string
                    example: "2025-09-05"
                  days:
                    type: array
                    items:
                      type: object
                  _publicInfo:
                    type: object
                    properties:
                      permission:
                        type: string
                        enum: [READ_ONLY, EDIT]
                        example: "READ_ONLY"
                      scope:
                        type: string
                        enum: [PUBLIC]
                        example: "PUBLIC"
                      isReadOnly:
                        type: boolean
                        example: true
                      accessCount:
                        type: integer
                        example: 15
                      lastAccessedAt:
                        type: string
                        format: date-time
                        example: "2025-01-15T10:30:00Z"
                      author:
                        type: object
                        properties:
                          name:
                            type: string
                            example: "匿名"
                          email:
                            type: [string, "null"]
                            example: "***@***.***"
                      ogp:
                        type: object
                        properties:
                          title:
                            type: string
                            example: "旅のしおり"
                          description:
                            type: string
                            example: "共有された旅のしおりです"
                          image:
                            type: [string, "null"]
                            example: "https://example.com/image.jpg"
                          url:
                            type: string
                            example: "https://example.com/public/itn_123"
                          type:
                            type: string
                            example: "article"
                          site_name:
                            type: string
                            example: "旅のしおり"
        '403':
          description: アクセス拒否
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 旅程が見つかりません
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # 旅程複製・マイグレーションAPI
  /api/itineraries/copy/{id}:
    post:
      summary: 旅程複製
      description: |
        認証済みユーザーが他のユーザーの旅程を複製して新しいIDで保存
        
        **アクセス制御**:
        - 認証必須
        - PUBLIC_LINKまたはPUBLIC公開範囲の旅程のみ複製可能
        - 自分の旅程は複製不可
        - 有効期限チェックあり
        
        **使用ミドルウェア**:
        - auth: JWT認証
        - rateLimit: リクエスト頻度制限（30 req/min）
      tags:
        - Itinerary Copy
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 複製元の旅程ID
          schema:
            type: string
            example: "itn_123"
      responses:
        '201':
          description: 旅程が正常に複製されました
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    example: "itn_456"
                  message:
                    type: string
                    example: "Itinerary copied successfully"
        '400':
          description: バリデーションエラーまたは自分の旅程の複製
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: アクセス拒否または期限切れ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 複製元の旅程が見つかりません
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/itineraries/migrate:
    post:
      summary: ローカル保存マイグレーション
      description: |
        認証済みユーザーが登録時にローカルストレージの旅程をDBに移行
        
        **制限事項**:
        - 最大50旅程まで移行可能
        - 各旅程のデータサイズは1MB以下
        - 重複チェックなし（新しいIDで作成）
        
        **使用ミドルウェア**:
        - auth: JWT認証
        - rateLimit: リクエスト頻度制限（30 req/min）
      tags:
        - Itinerary Copy
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - itineraries
              properties:
                itineraries:
                  type: array
                  items:
                    type: object
                    required:
                      - id
                      - data
                    properties:
                      id:
                        type: string
                        description: ローカルストレージの旅程ID
                        example: "local_123"
                      data:
                        type: object
                        description: 旅程データ（任意のJSON形式）
                  minItems: 1
                  maxItems: 50
                  description: 移行する旅程の配列
      responses:
        '200':
          description: マイグレーション完了
          content:
            application/json:
              schema:
                type: object
                properties:
                  migrated:
                    type: integer
                    example: 3
                  total:
                    type: integer
                    example: 5
                  errors:
                    type: array
                    items:
                      type: string
                    description: エラーメッセージ（エラーがある場合のみ）
                    example: ["Failed to migrate itinerary local_456"]
                  message:
                    type: string
                    example: "Migration completed. 3/5 itineraries migrated successfully"
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/events/complete:
    post:
      summary: イベント補完（AI機能）
      description: |
        2つのイベントの間に新しいイベントをOpenAI ChatGPT APIを使用して自動生成するAI機能
        
        **AI機能の詳細**:
        - 使用モデル: Cerebras（gpt-oss-120b）優先、OpenAI（gpt-4o-mini）フォールバック
        - 温度設定: 0.3（一貫性重視）
        - タイムアウト: 60秒
        - RAG機能: Tavily検索API（最大3回/実行）
        - 内部通信: FastAPI + LangChain 0.3 + LangGraph
        
        **生成されるイベントの特徴**:
        - 時刻は必ず "HH:MM" 形式
        - アイコンは指定されたリストから選択
        - 詳細な説明文を自動生成
        - JSONスキーマによる厳密な検証
        
        **使用ミドルウェア**:
        - rateLimit: リクエスト頻度制限（AI機能専用制限）
      tags:
        - Events
        - AI Features
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - event1
                - event2
              properties:
                event1:
                  $ref: '#/components/schemas/Event'
                  description: 最初のイベント（開始地点）
                event2:
                  $ref: '#/components/schemas/Event'
                  description: 2番目のイベント（終了点）
                dummy:
                  type: boolean
                  description: ダミーモードフラグ（テスト用、実際のAI呼び出しをスキップ）
                  example: false
            examples:
              basic_example:
                summary: 基本的なイベント補完
                value:
                  event1:
                    time: "10:00"
                    end_time: "10:30"
                    title: "出発"
                    description: "新宿駅から出発"
                    icon: "mdi-train"
                  event2:
                    time: "12:00"
                    end_time: "12:30"
                    title: "到着"
                    description: "東京駅に到着"
                    icon: "mdi-map-marker"
      parameters:
        - name: x-user-id
          in: header
          required: false
          schema:
            type: string
          description: ユーザーID（ログ用、オプション）
      responses:
        '200':
          description: AI生成されたイベント
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
              examples:
                generated_event:
                  summary: 生成されたイベント例
                  value:
                    time: "11:00"
                    end_time: "11:30"
                    title: "電車移動"
                    description: "新宿駅から東京駅まで電車で移動します。JR山手線または中央線を利用し、約1時間の移動時間です。"
                    icon: "mdi-train"
        '400':
          description: 必須フィールド不足
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: event1 and event2 are required in body
        '422':
          description: AI生成エラー（スキーマ検証失敗、API呼び出し失敗など）
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: AI generation failed
        '429':
          description: レート制限超過
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/itinerary-edit:
    post:
      summary: 旅程編集（AI機能）
      description: |
        OpenAI ChatGPT APIを使用して自然言語での旅程編集指示を理解し、旅程を自動更新するAI機能
        
        **AI機能の詳細**:
        - 使用モデル: Cerebras（gpt-oss-120b）優先、OpenAI（gpt-4o-mini）フォールバック
        - 自然言語理解: 日本語での編集指示を解析
        - 差分生成: 変更前後の差分をJSON Patch形式で提供
        - 変更説明: 実行された変更内容を自然言語で説明
        - 内部通信: FastAPI + LangChain 0.3 + LangGraph
        
        **対応する編集指示の例**:
        - "2日目の朝食を和食に変更してください"
        - "3日目の観光地を浅草寺に変更"
        - "移動時間を30分延長してください"
        - "夕食の予約時間を1時間遅らせてください"
        
        **使用ミドルウェア**:
        - rateLimit: リクエスト頻度制限（AI機能専用制限）
      tags:
        - Itinerary Edit
        - AI Features
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - originalItinerary
                - editPrompt
              properties:
                originalItinerary:
                  $ref: '#/components/schemas/Itinerary'
                  description: 編集対象の元の旅程データ
                editPrompt:
                  type: string
                  description: 変更したい内容の自然言語での説明
                  example: 2日目の朝食を和食レストランに変更してください
                  minLength: 1
                  maxLength: 1000
            examples:
              basic_edit:
                summary: 基本的な旅程編集
                value:
                  originalItinerary:
                    title: "東京観光旅行"
                    days:
                      - date: "2025-09-01"
                        events:
                          - time: "09:00"
                            end_time: "09:30"
                            title: "朝食"
                            description: "ホテルで朝食"
                            icon: "mdi-food"
                  editPrompt: "2日目の朝食を和食レストランに変更してください"
      responses:
        '200':
          description: 旅程編集成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/ItineraryEditResponse'
              examples:
                successful_edit:
                  summary: 編集成功例
                  value:
                    success: true
                    data:
                      modifiedItinerary:
                        title: "東京観光旅行"
                        days:
                          - date: "2025-09-01"
                            events:
                              - time: "09:00"
                                end_time: "09:30"
                                title: "和食朝食"
                                description: "築地市場の老舗和食レストランで朝食"
                                icon: "mdi-food"
                      diffPatch:
                        op: "replace"
                        path: "/days/0/events/0/title"
                        value: "和食朝食"
                      changeDescription: "2日目の朝食を和食レストランに変更しました"
        '400':
          description: バリデーションエラー（必須フィールド不足、不正なデータ形式など）
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: originalItinerary is required
        '422':
          description: AI生成エラー（編集指示の理解失敗、無効な編集結果など）
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: AI generation failed
        '429':
          description: レート制限超過
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: Internal server error
  /api/ai/events/complete:
    post:
      summary: イベント補完（AI機能・新経路）
      description: 既存 `/api/events/complete` と同等。内部FastAPI経由でLangChainを呼び出す。
      tags:
        - Events
        - AI Features
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/paths/~1api~1events~1complete/post/requestBody/content/application~1json/schema'
      parameters:
        - name: x-user-id
          in: header
          required: false
          schema:
            type: string
          description: ユーザーID（ログ用、オプション）
      responses:
        '200':
          description: AI生成されたイベント
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '400':
          $ref: '#/components/responses/BadRequest'
        '422':
          description: AI生成エラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/ai/itinerary-edit:
    post:
      summary: 旅程編集（AI機能・新経路）
      description: 既存 `/api/itinerary-edit` と同等。内部FastAPI経由でLangChainを呼び出す。
      tags:
        - Itinerary Edit
        - AI Features
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/paths/~1api~1itinerary-edit/post/requestBody/content/application~1json/schema'
      responses:
        '200':
          description: 旅程編集成功
          content:
            application/json:
              schema:
                $ref: '#/paths/~1api~1itinerary-edit/post/responses/200/content/application~1json/schema'
        '400':
          $ref: '#/components/responses/BadRequest'
        '422':
          description: AI生成エラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  error:
                    type: string
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # FastAPI内部サービスAPI
  /api/python/health:
    get:
      summary: FastAPI内部サービスのヘルスチェック
      description: |
        FastAPI内部サービス（Python + LangChain）の稼働状況を確認
        
        **使用ミドルウェア**:
        - rateLimit: リクエスト頻度制限（60 req/min）
      tags:
        - System
        - Internal Services
      responses:
        '200':
          description: FastAPIサービス正常稼働
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  service:
                    type: string
                    example: "fastapi-sidecar"
                  version:
                    type: string
                    example: "0.1.0"
                  environment_variables:
                    type: object
                    description: 環境変数の一覧
        '503':
          description: FastAPIサービスが利用できません
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "FastAPI service unavailable"
                  message:
                    type: string
                    example: "FastAPI sidecar service is not responding"
        '500':
          description: 内部サーバーエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Internal server error"
                  message:
                    type: string
                    example: "Failed to check FastAPI health"

  /api/python/health/auth:
    get:
      summary: FastAPI内部サービスの認証ヘルスチェック
      description: |
        FastAPI内部サービスの認証トークンの妥当性を確認（内部通信用）
        
        **使用ミドルウェア**:
        - rateLimit: リクエスト頻度制限（60 req/min）
      tags:
        - System
        - Internal Services
      responses:
        '200':
          description: 認証成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  message:
                    type: string
                    example: "Internal token is valid"
        '403':
          description: 認証トークンが無効です
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Authentication failed"
                  message:
                    type: string
                    example: "Internal token is invalid"
        '503':
          description: FastAPIサービスが利用できません
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "FastAPI service unavailable"
                  message:
                    type: string
                    example: "FastAPI sidecar service is not responding"
        '500':
          description: 内部サーバーエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Internal server error"
                  message:
                    type: string
                    example: "Failed to check FastAPI auth health"

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: access_token
      description: JWT認証トークン（HttpOnly Cookie）


  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          example: unauthorized
        message:
          type: string
          example: Invalid credentials

    ValidationError:
      type: object
      properties:
        error:
          type: string
          enum: [invalid_body, invalid_query, invalid_params]
          example: invalid_body
        message:
          type: string
          example: Request validation failed
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
                example: email
              message:
                type: string
                example: Invalid email format

    UserProfile:
      type: object
      properties:
        id:
          type: string
          example: "usr_123"
        email:
          type: string
          format: email
          example: "user@example.com"
        name:
          type: [string, "null"]
          example: "Taro Yamada"
        emailVerified:
          type: [string, "null"]
          format: date-time
          example: "2025-01-01T00:00:00Z"
        createdAt:
          type: string
          format: date-time
          example: "2025-01-01T00:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-01-01T00:00:00Z"

    ItineraryListItem:
      type: object
      properties:
        id:
          type: string
          example: "itn_123"
        data:
          type: object
          description: 旅程データ（任意のJSON形式）
        createdAt:
          type: string
          format: date-time
          example: "2025-01-01T00:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-01-01T00:00:00Z"
        share:
          $ref: '#/components/schemas/ItineraryShareInfo'
          description: 共有設定情報（includeShare=trueの場合のみ含まれる）

    ItineraryShareInfo:
      type: object
      properties:
        permission:
          type: string
          enum: [READ_ONLY, EDIT]
          description: 共有権限レベル
          example: "READ_ONLY"
        hasPassword:
          type: boolean
          description: パスワード保護の有無
          example: true
        expiresAt:
          type: [string, "null"]
          format: date-time
          description: 有効期限（nullの場合は無期限）
          example: "2024-12-31T23:59:59Z"
        scope:
          type: string
          enum: [PRIVATE, PUBLIC_LINK, PUBLIC]
          description: 公開範囲
          example: "PUBLIC_LINK"

    Pagination:
      type: object
      properties:
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 10
        total:
          type: integer
          example: 100
        totalPages:
          type: integer
          example: 10
        hasNext:
          type: boolean
          example: true
        hasPrev:
          type: boolean
          example: false

    Event:
      type: object
      required:
        - time
        - end_time
        - title
        - description
        - icon
      properties:
        time:
          type: string
          pattern: '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$'
          description: 開始時刻（HH:MM形式）
          example: "10:00"
        end_time:
          type: string
          pattern: '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$'
          description: 終了時刻（HH:MM形式）
          example: "11:30"
        title:
          type: string
          description: イベントタイトル
          example: "出発"
        description:
          type: string
          description: イベントの詳細説明
          example: "新宿駅から電車で移動"
        icon:
          type: string
          enum:
            - "mdi-map-marker"
            - "mdi-walk"
            - "mdi-train"
            - "mdi-bike"
            - "mdi-bus"
            - "mdi-airplane"
            - "mdi-camera"
            - "mdi-food"
            - "mdi-car"
          description: アイコン名
          example: "mdi-train"

    Day:
      type: object
      required:
        - events
      properties:
        date:
          type: string
          format: date
          description: 日付（オプション）
          example: "2025-09-01"
        events:
          type: array
          items:
            $ref: '#/components/schemas/Event'
          description: その日のイベント一覧

    Itinerary:
      type: object
      required:
        - title
        - days
      properties:
        title:
          type: string
          description: 旅程タイトル
          example: "東京観光旅行"
        subtitle:
          type: string
          description: サブタイトル（オプション）
          example: "3日間の東京観光"
        description:
          type: string
          description: 旅程の説明（オプション）
          example: "初めての東京旅行で主要観光地を巡ります"
        days:
          type: array
          items:
            $ref: '#/components/schemas/Day'
          description: 日程一覧
          minItems: 1

    ItineraryRecord:
      type: object
      properties:
        id:
          type: string
          example: abc123def456
        data:
          type: string
          description: 旅程データ（JSON文字列）
        createdAt:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"
        userId:
          type: [string, "null"]
          example: user123

    ItineraryEditResponse:
      type: object
      required:
        - modifiedItinerary
        - diffPatch
        - changeDescription
      properties:
        modifiedItinerary:
          $ref: '#/components/schemas/Itinerary'
        diffPatch:
          type: object
          description: 旅程の差分（JSON patch）
        changeDescription:
          type: string
          description: 変更内容の自然言語説明
          example: "2日目の朝食を和食レストランに変更しました"

  responses:
    BadRequest:
      description: リクエストが不正です
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
          examples:
            default:
              value:
                error: "invalid_body"
                message: "Request validation failed"
                details:
                  - field: "name"
                    message: "Name must be 255 characters or less"

    Unauthorized:
      description: 認証が必要です
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            default:
              value:
                error: "unauthorized"
                message: "Access token required"

    Forbidden:
      description: アクセスが拒否されました
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            default:
              value:
                error: "forbidden"
                message: "Access denied"

    NotFound:
      description: リソースが見つかりません
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            default:
              value:
                error: "not_found"
                message: "Resource not found"

    InternalServerError:
      description: 内部サーバーエラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            default:
              value:
                error: "internal_server_error"
                message: "An unexpected error occurred"
    TooManyRequests:
      description: レート制限に達しました
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            default:
              value:
                error: "too_many_requests"
                message: "Rate limit exceeded"
    ServiceUnavailable:
      description: サービス一時不可
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            default:
              value:
                error: "service_unavailable"
                message: "Service temporarily unavailable"

tags:
  - name: System
    description: システム関連
  - name: Authentication
    description: 認証・認可
  - name: Users
    description: ユーザー管理
  - name: Itineraries
    description: 旅のしおり管理
  - name: Itinerary Share
    description: 旅程共有機能
  - name: Public Access
    description: 公開旅程アクセス
  - name: Itinerary Copy
    description: 旅程複製・マイグレーション
  - name: Events
    description: イベント管理
  - name: Itinerary Edit
    description: 旅程編集
  - name: AI Features
    description: AI機能（OpenAI ChatGPT API統合）
  - name: Internal Services
    description: 内部サービス（FastAPI + LangChain）
