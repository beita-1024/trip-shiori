openapi: 3.0.3
info:
  title: Trip Shiori API
  description: |
    旅のしおり作成・管理システムのAPI
    
    このAPIは旅行の行程を作成・編集・管理するためのRESTful APIです。
    AI機能を使用してイベントの補完や旅程の編集をサポートします。
    
    
    ## グローバルミドルウェア
    以下のミドルウェアは全エンドポイントで自動的に適用されます：
    - **CORS**: クロスオリジンリクエストの制御（ブラウザの同一オリジンポリシー対応）
    - **express.json**: JSONリクエストボディの解析
    - **cookieParser**: Cookieの解析（JWT認証用）
    
    ## ミドルウェア一覧
    このAPIでは以下のミドルウェアを使用しています：
    
    ### auth（JWT認証）
    - **処理内容**: JWTトークンの検証とユーザー認証
    - **適用範囲**: 認証が必要なエンドポイント
    - **目的**: セキュリティ確保とユーザー識別
    
    ### rateLimit（レート制限）
    - **処理内容**: リクエスト頻度の制限
    - **制限値**:
      - 一般エンドポイント: 60 req/min
      - パスワードリセット: 15分あたり3回
      - パスワードリセット確認: 15分あたり5回
      - AI機能: 専用制限
    - **目的**: サーバー負荷軽減とセキュリティ向上
    
    ### validation（バリデーション）
    - **処理内容**: Zodスキーマを使用したリクエストデータの検証
    - **適用範囲**: リクエストボディ・クエリパラメータ・パスパラメータ
    - **目的**: 型安全性確保とデータ整合性チェック
    
    ### CORS（Cross-Origin Resource Sharing）
    - **処理内容**: クロスオリジンリクエストの制御
    - **適用範囲**: 全エンドポイント（グローバル設定）
    - **目的**: ブラウザの同一オリジンポリシー対応とセキュリティ
    
    ### express.json（JSONパーサー）
    - **処理内容**: JSONリクエストボディの解析
    - **適用範囲**: 全エンドポイント（グローバル設定）
    - **目的**: リクエストボディの解析
    
    ### cookieParser（Cookieパーサー）
    - **処理内容**: Cookieの解析
    - **適用範囲**: 全エンドポイント（グローバル設定）
    - **目的**: JWT認証用のCookie処理
    
  version: 1.0.0
  contact:
    name: Trip Shiori Team
  license:
    name: None

servers:
  - url: http://localhost:4002
    description: 開発環境
  - url: https://xxxxxx.com
    description: 本番環境

paths:
  /health:
    get:
      summary: ヘルスチェック
      description: サーバーの稼働状況を確認
      tags:
        - System
      responses:
        '200':
          description: サーバー正常稼働
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true

  /auth/register:
    post:
      summary: ユーザー登録
      description: 新しいユーザーアカウントを作成し、メール認証を送信
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  minLength: 8
                  maxLength: 1024
                  pattern: '^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).*$'
                  description: 8文字以上1024文字以下、大文字・小文字・数字・特殊文字を含む
                  example: SecurePass123!
                name:
                  type: string
                  description: 表示名（任意）
                  example: 田中太郎
      responses:
        '204':
          description: 登録成功（メール送信完了）
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '409':
          description: メールアドレス重複
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/verify-email:
    get:
      summary: メール認証
      description: メール認証トークンを検証し、ユーザーを認証済みに更新
      tags:
        - Authentication
      parameters:
        - name: uid
          in: query
          required: true
          schema:
            type: string
          description: ユーザーID
        - name: token
          in: query
          required: true
          schema:
            type: string
          description: 認証トークン
      responses:
        '302':
          description: 認証成功（ダッシュボードへリダイレクト、JWT Cookie設定）
          headers:
            Location:
              description: リダイレクト先URL
              schema:
                type: string
            Set-Cookie:
              description: JWT Cookie
              schema:
                type: string
        '400':
          description: 無効・期限切れトークン
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      summary: ユーザーログイン
      description: メールアドレスとパスワードでログインし、JWT Cookieを発行
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  minLength: 1
                  maxLength: 1024
                  description: パスワード（ログイン時は強度チェックなし）
                  example: SecurePass123!
      responses:
        '204':
          description: ログイン成功（HttpOnly CookieでJWT発行）
          headers:
            Set-Cookie:
              description: JWT Cookie
              schema:
                type: string
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: 認証失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: メール未認証
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      summary: ユーザーログアウト
      description: |
        認証済みユーザーをログアウトし、JWT Cookieを無効化
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
      tags:
        - Authentication
      security:
        - cookieAuth: []
      responses:
        '204':
          description: ログアウト成功（Cookie無効化）
          headers:
            Clear-Cookie:
              description: Cookie無効化
              schema:
                type: string
        '401':
          description: 未認証
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/protected:
    get:
      summary: 保護されたリソース
      description: |
        認証済みユーザーのみアクセス可能なリソースの例
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
      tags:
        - Authentication
      security:
        - cookieAuth: []
      responses:
        '200':
          description: 認証済みユーザー情報
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                        example: user123
                      email:
                        type: string
                        example: user@example.com
                  message:
                    type: string
                    example: This is a protected resource
        '401':
          description: 未認証
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/password-reset/request:
    post:
      summary: パスワードリセットリクエスト
      description: |
        メールアドレスを受け取り、パスワードリセットトークンを発行してメール送信
        
        **使用ミドルウェア**:
        - rateLimit: レート制限（15分あたり3回）- スパム防止とセキュリティ向上のため
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        '204':
          description: リクエスト受付完了（存在不問で同一応答）
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          description: レート制限超過
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/password-reset/confirm:
    post:
      summary: パスワードリセット確認
      description: |
        パスワードリセットトークンを検証し、新しいパスワードを設定
        
        **使用ミドルウェア**:
        - rateLimit: レート制限（15分あたり5回）- ブルートフォース攻撃防止のため
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - uid
                - token
                - newPassword
              properties:
                uid:
                  type: string
                  example: user123
                token:
                  type: string
                  example: abc123...
                newPassword:
                  type: string
                  minLength: 8
                  maxLength: 1024
                  pattern: '^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).*$'
                  description: 8文字以上1024文字以下、大文字・小文字・数字・特殊文字を含む
                  example: NewSecurePass123!
      responses:
        '204':
          description: パスワードリセット成功
        '400':
          description: バリデーションエラーまたは無効・期限切れトークン
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          description: レート制限超過
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ユーザー管理API

  /api/users/profile:
    get:
      summary: ユーザープロフィール取得
      description: |
        認証済みユーザーのプロフィール情報を取得
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
      tags:
        - Users
      security:
        - cookieAuth: []
      responses:
        '200':
          description: ユーザープロフィール情報
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      summary: ユーザープロフィール更新
      description: |
        認証済みユーザーのプロフィール情報を更新
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Users
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  maxLength: 255
                  example: "New Name"
      responses:
        '200':
          description: 更新されたユーザープロフィール情報
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/users/password:
    put:
      summary: パスワード変更
      description: |
        認証済みユーザーのパスワードを変更
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Users
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - currentPassword
                - newPassword
              properties:
                currentPassword:
                  type: string
                  minLength: 1
                  description: 現在のパスワード（既存ユーザーの弱いパスワード対応のため強度チェックなし）
                  example: "currentpass"
                newPassword:
                  type: string
                  minLength: 8
                  maxLength: 1024
                  pattern: '^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).*$'
                  description: 8文字以上1024文字以下、大文字・小文字・数字・特殊文字を含む
                  example: "NewSecurePass123!"
      responses:
        '204':
          description: パスワードが正常に変更されました
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/users/account/delete:
    post:
      summary: アカウント削除
      description: |
        認証済みユーザーのアカウントを削除（パスワード確認必須）
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Users
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - password
              properties:
                password:
                  type: string
                  minLength: 1
                  maxLength: 1024
                  description: 現在のパスワード（アカウント削除確認用、強度チェックなし）
                  example: "UserPass123!"
      responses:
        '204':
          description: アカウントが正常に削除されました
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # 旅程管理CRUD API
  /api/itineraries:
    get:
      summary: 旅程一覧取得
      description: |
        認証済みユーザーの旅程一覧を取得（ページネーション対応）
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
        - validation: クエリパラメータのバリデーション（Zodスキーマ）
      tags:
        - Itineraries
      security:
        - cookieAuth: []
      parameters:
        - name: page
          in: query
          description: ページ番号（1から開始）
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: 1ページあたりの件数（最大100）
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: sort
          in: query
          description: ソートフィールド
          required: false
          schema:
            type: string
            enum: [createdAt, updatedAt]
            default: createdAt
        - name: order
          in: query
          description: ソート順序
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: 旅程一覧とページネーション情報
          content:
            application/json:
              schema:
                type: object
                properties:
                  itineraries:
                    type: array
                    items:
                      $ref: '#/components/schemas/ItineraryListItem'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      summary: 旅程作成
      description: |
        認証済みユーザーが新しい旅程を作成
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Itineraries
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: 旅程データ（任意のJSON形式）
              example:
                title: "Tokyo Trip"
                start_date: "2025-09-01"
                end_date: "2025-09-05"
                days: []
      responses:
        '201':
          description: 旅程が正常に作成されました
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    example: "itn_123"
                  message:
                    type: string
                    example: "Itinerary created successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/itineraries/{id}:
    get:
      summary: 旅程詳細取得
      description: |
        認証済みユーザーが自分の旅程を取得、または共有設定によりアクセス可能な旅程を取得
        
        共有設定がある場合は認証不要でアクセス可能です。公開範囲（scope）に応じて以下のアクセス制御が行われます：
        - PUBLIC_LINK: リンクを知っている人全員（認証不要）
        - AUTHENTICATED_USERS: 認証済みユーザーのみ
        - RESTRICTED_EMAILS: 特定のメールアドレスのみ
        - PUBLIC: 全体公開（認証不要）
        
        **使用ミドルウェア**:
        - auth: JWT検証（共有設定がある場合は認証不要）
        - rateLimit: リクエスト頻度制限（60 req/min）
      tags:
        - Itineraries
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      responses:
        '200':
          description: 旅程データ（JSON形式）
          content:
            application/json:
              schema:
                type: object
                description: 旅程データ（任意のJSON形式）
                example:
                  title: "Tokyo Trip"
                  start_date: "2025-09-01"
                  end_date: "2025-09-05"
                  days: []
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      summary: 旅程更新
      description: |
        認証済みユーザーが自分の旅程を更新
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Itineraries
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: 更新する旅程データ
              example:
                title: "Updated Tokyo Trip"
                start_date: "2025-09-01"
                end_date: "2025-09-05"
                days: []
      responses:
        '200':
          description: 旅程が正常に更新されました
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Itinerary updated successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      summary: 旅程削除
      description: |
        認証済みユーザーが自分の旅程を削除
        
        **使用ミドルウェア**:
        - auth: JWT検証（認証済みユーザーのみアクセス可能）
        - rateLimit: リクエスト頻度制限（60 req/min）
      tags:
        - Itineraries
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      responses:
        '204':
          description: 旅程が正常に削除されました
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # 旅程共有機能API
  /api/itineraries/{id}/share:
    post:
      summary: 共有設定作成
      description: |
        旅程の共有設定を作成（認証不要）
        
        旅程IDベースの共有URLを生成し、権限レベル、パスワード保護、有効期限の設定を可能にします。
        所有者のない旅程も許可し、共有設定のみでアクセス制御を行います。
        
        **使用ミドルウェア**:
        - rateLimit: リクエスト頻度制限（30 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Itinerary Share
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - permission
                - scope
              properties:
                permission:
                  type: string
                  enum: [READ_ONLY, EDIT]
                  description: 共有権限レベル
                  example: "READ_ONLY"
                password:
                  type: string
                  minLength: 8
                  maxLength: 128
                  description: 共有パスワード（オプション）
                  example: "SharePass123!"
                expiresAt:
                  type: string
                  format: date-time
                  description: 有効期限（ISO 8601形式、オプション）
                  example: "2024-12-31T23:59:59Z"
                scope:
                  type: string
                  enum: [PUBLIC_LINK, RESTRICTED_EMAILS, AUTHENTICATED_USERS, PUBLIC]
                  description: 公開範囲
                  example: "PUBLIC_LINK"
                allowedEmails:
                  type: array
                  items:
                    type: string
                    format: email
                  maxItems: 100
                  description: 許可されたメールアドレスリスト（RESTRICTED_EMAILS時のみ使用）
                  example: ["user@example.com", "friend@example.com"]
      responses:
        '201':
          description: 共有設定が正常に作成されました
          content:
            application/json:
              schema:
                type: object
                properties:
                  shareUrl:
                    type: string
                    description: 共有URL
                    example: "https://example.com/shared/itn_123"
                  message:
                    type: string
                    example: "Share settings created successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: 旅程が見つかりません
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "itinerary_not_found"
                  message:
                    type: string
                    example: "Itinerary not found"
        '409':
          description: 既に共有設定が存在します
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "share_already_exists"
                  message:
                    type: string
                    example: "Share settings already exist for this itinerary"
        '500':
          $ref: '#/components/responses/InternalServerError'

    get:
      summary: 共有設定取得
      description: |
        旅程の共有設定を取得（認証不要）
        
        **使用ミドルウェア**:
        - rateLimit: リクエスト頻度制限（30 req/min）
      tags:
        - Itinerary Share
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      responses:
        '200':
          description: 共有設定情報
          content:
            application/json:
              schema:
                type: object
                properties:
                  permission:
                    type: string
                    enum: [READ_ONLY, EDIT]
                    description: 共有権限レベル
                    example: "READ_ONLY"
                  hasPassword:
                    type: boolean
                    description: パスワード保護の有無
                    example: true
                  expiresAt:
                    type: string
                    format: date-time
                    nullable: true
                    description: 有効期限（nullの場合は無期限）
                    example: "2024-12-31T23:59:59Z"
                  scope:
                    type: string
                    enum: [PUBLIC_LINK, RESTRICTED_EMAILS, AUTHENTICATED_USERS, PUBLIC]
                    description: 公開範囲
                    example: "PUBLIC_LINK"
                  allowedEmails:
                    type: array
                    items:
                      type: string
                      format: email
                    nullable: true
                    description: 許可されたメールアドレスリスト
                    example: ["user@example.com", "friend@example.com"]
        '404':
          description: 共有設定が見つかりません
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "share_not_found"
                  message:
                    type: string
                    example: "Share settings not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      summary: 共有設定更新
      description: |
        旅程の共有設定を更新（部分更新対応、認証不要）
        
        **使用ミドルウェア**:
        - rateLimit: リクエスト頻度制限（30 req/min）
        - validation: リクエストボディのバリデーション（Zodスキーマ）
      tags:
        - Itinerary Share
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                permission:
                  type: string
                  enum: [READ_ONLY, EDIT]
                  description: 共有権限レベル
                  example: "EDIT"
                password:
                  type: string
                  nullable: true
                  minLength: 8
                  maxLength: 128
                  description: 共有パスワード（nullでパスワード削除）
                  example: "NewSharePass123!"
                expiresAt:
                  type: string
                  format: date-time
                  nullable: true
                  description: 有効期限（nullで無期限）
                  example: "2024-12-31T23:59:59Z"
                scope:
                  type: string
                  enum: [PUBLIC_LINK, RESTRICTED_EMAILS, AUTHENTICATED_USERS, PUBLIC]
                  description: 公開範囲
                  example: "RESTRICTED_EMAILS"
                allowedEmails:
                  type: array
                  items:
                    type: string
                    format: email
                  nullable: true
                  maxItems: 100
                  description: 許可されたメールアドレスリスト（nullでリスト削除）
                  example: ["user@example.com", "friend@example.com"]
      responses:
        '200':
          description: 共有設定が正常に更新されました
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Share settings updated successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: 共有設定が見つかりません
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "share_not_found"
                  message:
                    type: string
                    example: "Share settings not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      summary: 共有設定削除
      description: |
        旅程の共有設定を削除（認証不要）
        
        **使用ミドルウェア**:
        - rateLimit: リクエスト頻度制限（30 req/min）
      tags:
        - Itinerary Share
      parameters:
        - name: id
          in: path
          required: true
          description: 旅程の一意識別子
          schema:
            type: string
            example: "itn_123"
      responses:
        '204':
          description: 共有設定が正常に削除されました
        '404':
          description: 共有設定が見つかりません
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "share_not_found"
                  message:
                    type: string
                    example: "Share settings not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/events/complete:
    post:
      summary: イベント補完
      description: 2つのイベントの間に新しいイベントを生成するAI機能
      tags:
        - Events
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - event1
                - event2
              properties:
                event1:
                  $ref: '#/components/schemas/Event'
                event2:
                  $ref: '#/components/schemas/Event'
                dummy:
                  type: boolean
                  description: ダミーモードフラグ（オプション）
                  example: false
      parameters:
        - name: x-user-id
          in: header
          required: false
          schema:
            type: string
          description: ユーザーID（オプション）
      responses:
        '200':
          description: 生成されたイベント
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '400':
          description: 必須フィールド不足
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: event1 and event2 are required in body
        '422':
          description: AI生成エラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: AI generation failed

  /api/itinerary-edit:
    post:
      summary: 旅程編集
      description: AIを使用して旅程を編集
      tags:
        - Itinerary Edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - originalItinerary
                - editPrompt
              properties:
                originalItinerary:
                  $ref: '#/components/schemas/Itinerary'
                editPrompt:
                  type: string
                  description: 変更したい内容の説明
                  example: 2日目の朝食を和食に変更してください
      responses:
        '200':
          description: 旅程編集成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/ItineraryEditResponse'
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: originalItinerary is required
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: Internal server error

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: access_token
      description: JWT認証トークン（HttpOnly Cookie）


  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          example: unauthorized
        message:
          type: string
          example: Invalid credentials

    ValidationError:
      type: object
      properties:
        error:
          type: string
          enum: [invalid_body, invalid_query, invalid_params]
          example: invalid_body
        message:
          type: string
          example: Request validation failed
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
                example: email
              message:
                type: string
                example: Invalid email format

    UserProfile:
      type: object
      properties:
        id:
          type: string
          example: "usr_123"
        email:
          type: string
          format: email
          example: "user@example.com"
        name:
          type: string
          nullable: true
          example: "Taro Yamada"
        emailVerified:
          type: string
          format: date-time
          nullable: true
          example: "2025-01-01T00:00:00Z"
        createdAt:
          type: string
          format: date-time
          example: "2025-01-01T00:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-01-01T00:00:00Z"

    ItineraryListItem:
      type: object
      properties:
        id:
          type: string
          example: "itn_123"
        data:
          type: object
          description: 旅程データ（任意のJSON形式）
        createdAt:
          type: string
          format: date-time
          example: "2025-01-01T00:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-01-01T00:00:00Z"

    Pagination:
      type: object
      properties:
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 10
        total:
          type: integer
          example: 100
        totalPages:
          type: integer
          example: 10
        hasNext:
          type: boolean
          example: true
        hasPrev:
          type: boolean
          example: false

    Event:
      type: object
      required:
        - time
        - end_time
        - title
        - description
        - icon
      properties:
        time:
          type: string
          pattern: '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$'
          description: 開始時刻（HH:MM形式）
          example: "10:00"
        end_time:
          type: string
          pattern: '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$'
          description: 終了時刻（HH:MM形式）
          example: "11:30"
        title:
          type: string
          description: イベントタイトル
          example: "出発"
        description:
          type: string
          description: イベントの詳細説明
          example: "新宿駅から電車で移動"
        icon:
          type: string
          enum:
            - "mdi-map-marker"
            - "mdi-walk"
            - "mdi-train"
            - "mdi-bike"
            - "mdi-bus"
            - "mdi-airplane"
            - "mdi-camera"
            - "mdi-food"
            - "mdi-car"
          description: アイコン名
          example: "mdi-train"

    Day:
      type: object
      required:
        - events
      properties:
        date:
          type: string
          format: date
          description: 日付（オプション）
          example: "2025-09-01"
        events:
          type: array
          items:
            $ref: '#/components/schemas/Event'
          description: その日のイベント一覧

    Itinerary:
      type: object
      required:
        - title
        - days
      properties:
        title:
          type: string
          description: 旅程タイトル
          example: "東京観光旅行"
        subtitle:
          type: string
          description: サブタイトル（オプション）
          example: "3日間の東京観光"
        description:
          type: string
          description: 旅程の説明（オプション）
          example: "初めての東京旅行で主要観光地を巡ります"
        days:
          type: array
          items:
            $ref: '#/components/schemas/Day'
          description: 日程一覧

    ItineraryRecord:
      type: object
      properties:
        id:
          type: string
          example: abc123def456
        data:
          type: string
          description: 旅程データ（JSON文字列）
        createdAt:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"
        userId:
          type: string
          nullable: true
          example: user123

    ItineraryEditResponse:
      type: object
      required:
        - modifiedItinerary
        - diffPatch
        - changeDescription
      properties:
        modifiedItinerary:
          $ref: '#/components/schemas/Itinerary'
        diffPatch:
          type: object
          description: 旅程の差分（JSON patch）
        changeDescription:
          type: string
          description: 変更内容の自然言語説明
          example: "2日目の朝食を和食レストランに変更しました"

  responses:
    BadRequest:
      description: リクエストが不正です
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
          example:
            error: "invalid_body"
            message: "Request validation failed"
            details:
              - field: "name"
                message: "Name must be 255 characters or less"

    Unauthorized:
      description: 認証が必要です
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "unauthorized"
            message: "Access token required"

    Forbidden:
      description: アクセスが拒否されました
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "forbidden"
            message: "Access denied"

    NotFound:
      description: リソースが見つかりません
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "not_found"
            message: "Resource not found"

    InternalServerError:
      description: 内部サーバーエラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "internal_server_error"
            message: "An unexpected error occurred"

tags:
  - name: System
    description: システム関連
  - name: Authentication
    description: 認証・認可
  - name: Users
    description: ユーザー管理
  - name: Itineraries
    description: 旅のしおり管理
  - name: Events
    description: イベント管理
  - name: Itinerary Edit
    description: 旅程編集
