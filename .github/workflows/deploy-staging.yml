
# ç°¡æ˜“ç¢ºèªç’°å¢ƒç”¨ãƒ‡ãƒ—ãƒ­ã‚¤
# ãƒ‡ãƒãƒƒã‚°ã®ã—ã‚„ã™ã•ã‚’è€ƒãˆã¦CapRoverã‚’é¸æŠ
# ä¸»ã«Makeã‹ã‚‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã™ã‚‹ãŒã€
# GCPã‹ã‚‰CapRoverç’°å¢ƒã«ç§»ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€
# Github Actionsã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚‚æ®‹ã—ã¦ãŠã
name: CapRover Staging Deploy

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
# - push: ç„¡åŠ¹åŒ–
# - workflow_dispatch: æ‰‹å‹•å®Ÿè¡Œæ™‚ï¼ˆãƒ–ãƒ©ãƒ³ãƒé¸æŠå¯èƒ½ï¼‰
on:
  push:
    branches:
      - xxxxx # é–‹ç™ºç”¨ã«Makeã‚‚ã—ãã¯æ‰‹å‹•å®Ÿè¡Œã‚’ã™ã‚‹ã®ã§ç„¡åŠ¹ã«ã—ã¦ãŠãã€‚
  workflow_dispatch:
    inputs:
      branch:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ"
        required: true
        default: "main"
        type: string

jobs:
  deploy-caprover:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        working-directory: .
      
      - name: Deploy to CapRover
        env:
          CAPROVER_URL: ${{ secrets.CAPROVER_URL }}
          CAPROVER_TOKEN_FE: ${{ secrets.CAPROVER_TOKEN_FE }}
          CAPROVER_TOKEN_BE: ${{ secrets.CAPROVER_TOKEN_BE }}
          CAPROVER_APP_FE: ${{ secrets.CAPROVER_APP_FE }}
          CAPROVER_APP_BE: ${{ secrets.CAPROVER_APP_BE }}
          BRANCH: ${{ inputs.branch || github.ref_name }}
        run: |
          set -euo pipefail
          echo "ğŸš€ Deploying to CapRover..."
          echo "Branch: ${BRANCH}"
          echo "Commit: ${{ github.sha }}"
          echo "Trigger: ${{ github.event_name }}"
          
          # ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
          if [ -z "$CAPROVER_URL" ]; then
            echo "âŒ CAPROVER_URL is not set"
            exit 1
          fi
          if [ -z "$CAPROVER_TOKEN_FE" ] || [ -z "$CAPROVER_TOKEN_BE" ]; then
            echo "âŒ CapRover tokens are not set"
            exit 1
          fi
          if [ -z "$CAPROVER_APP_FE" ] || [ -z "$CAPROVER_APP_BE" ]; then
            echo "âŒ CapRover app names are not set"
            exit 1
          fi
          
          # Makefileã‚’ä½¿ç”¨ã—ã¦CapRoverã«ãƒ‡ãƒ—ãƒ­ã‚¤
          BRANCH="${BRANCH}" make deploy-cap
          
          echo "âœ… CapRover deployment completed successfully"
