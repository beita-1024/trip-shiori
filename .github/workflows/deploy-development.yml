# é–‹ç™ºç’°å¢ƒç”¨ãƒ‡ãƒ—ãƒ­ã‚¤
# GCP Cloud Run + Cloud SQLæ§‹æˆ
name: GCP Development Deploy

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
# - push: mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥æ™‚ï¼ˆé–‹ç™ºç’°å¢ƒ/ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç”¨ï¼‰
# - workflow_dispatch: æ‰‹å‹•å®Ÿè¡Œæ™‚ï¼ˆãƒ–ãƒ©ãƒ³ãƒé¸æŠå¯èƒ½ï¼‰
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ"
        required: true
        default: "main"
        type: string

jobs:
  deploy-gcp-development:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref_name }}
      
      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'
          project_id: portfolio-472821
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
      
      - name: Setup Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate terraform.tfvars
        env:
          GCP_PROJECT_ID: portfolio-472821
          GCP_REGION: asia-northeast1
          GCP_ZONE: asia-northeast1-a
          DB_NAME: trip_shiori
          DB_USER: trip_shiori_user
          SMTP_HOST: smtp.gmail.com
          SMTP_PORT: "587"
          SMTP_SECURE: "false"
        run: |
          set -euo pipefail
          echo "ğŸ”§ terraform.tfvarsã‚’ç”Ÿæˆä¸­..."
          ./scripts/generate-tfvars.sh dev
          echo "âœ… terraform.tfvarsãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
      
      - name: Check existing resources
        run: |
          echo "Checking existing GCP resources..."
          gcloud compute networks list --filter="name:trip-shiori-dev-vpc" || echo "No existing VPC"
          gcloud run services list --region=asia-northeast1 --filter="metadata.name:trip-shiori-dev-frontend" || echo "No existing Cloud Run services"
      
      - name: Run Database Migration
        env:
          GCP_PROJECT_ID: portfolio-472821
        run: |
          set -euo pipefail
          echo "ğŸ”„ Running database migration..."
          
          # Cloud SQL Proxy ã‚’ä½¿ç”¨ã—ã¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          cd backend
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ã‚’å–å¾—
          DB_HOST=$(gcloud sql instances describe trip-shiori-dev-db-instance --format="value(ipAddresses[0].ipAddress)")
          DB_NAME="trip_shiori"
          DB_USER="trip_shiori_user"
          
          # ç’°å¢ƒå¤‰æ•°è¨­å®š
          export DATABASE_URL="postgresql://${DB_USER}:$(gcloud secrets versions access latest --secret=trip-shiori-dev-database-password)@${DB_HOST}:5432/${DB_NAME}?sslmode=require"
          
          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          npx prisma migrate deploy
          npx prisma generate
          
          echo "âœ… Database migration completed successfully"

      - name: Deploy to GCP Development
        env:
          GIT_SHA: ${{ github.sha }}
          GCP_PROJECT_ID: portfolio-472821
        run: |
          set -euo pipefail
          echo "Deploying to GCP Development..."
          echo "Branch: ${{ github.event.inputs.branch || github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Trigger: ${{ github.event_name }}"
          
          # ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
          if [ -z "$GCP_PROJECT_ID" ]; then
            echo "âŒ GCP_PROJECT_ID is not set"
            exit 1
          fi
          
          # é–‹ç™ºç’°å¢ƒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨
          make deploy-gcp-dev-auto
          
          echo "âœ… GCP Development deployment completed successfully"
      
      - name: Verify deployment
        run: |
          echo "Verifying development deployment..."
          
          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®ç¢ºèª
          echo "Backend service status:"
          gcloud run services describe trip-shiori-dev-backend \
            --region=asia-northeast1 \
            --project=portfolio-472821 \
            --format="value(status.url,status.conditions[0].state)" || echo "âš ï¸  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          
          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®ç¢ºèª
          echo "Frontend service status:"
          gcloud run services describe trip-shiori-dev-frontend \
            --region=asia-northeast1 \
            --project=portfolio-472821 \
            --format="value(status.url,status.conditions[0].state)" || echo "âš ï¸  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèª
          echo "Database status:"
          gcloud sql instances describe trip-shiori-dev-db-instance \
            --project=portfolio-472821 \
            --format="value(state)" || echo "âš ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          
          echo "âœ… Development deployment verification completed"
      
      - name: Post deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Development deployment successful!"
            echo "Backend URL: https://dev-api.trip.beita.dev"
            echo "Frontend URL: https://dev-app.trip.beita.dev"
          else
            echo "âŒ Development deployment failed!"
            exit 1
          fi
