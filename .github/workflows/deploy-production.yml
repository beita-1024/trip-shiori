# æœ¬ç•ªç’°å¢ƒç”¨ãƒ‡ãƒ—ãƒ­ã‚¤
# GCP Cloud Run + Cloud SQLæ§‹æˆ
name: GCP Production Deploy

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
# - push: v*ã‚¿ã‚°ã«ãƒ—ãƒƒã‚·ãƒ¥æ™‚ï¼ˆæœ¬ç•ªç’°å¢ƒç”¨ï¼‰
# - workflow_dispatch: æ‰‹å‹•å®Ÿè¡Œæ™‚ï¼ˆãƒ–ãƒ©ãƒ³ãƒé¸æŠå¯èƒ½ï¼‰
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      branch:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ"
        required: true
        default: "main"
        type: string

jobs:
  deploy-gcp-production:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref_name }}
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'
          project_id: portfolio-472821
      
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
      
      - name: Setup Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate terraform.tfvars
        env:
          GCP_PROJECT_ID: portfolio-472821
          GCP_REGION: asia-northeast1
          GCP_ZONE: asia-northeast1-a
          DB_NAME: trip_shiori
          DB_USER: trip_shiori_user
          SMTP_HOST: smtp.gmail.com
          SMTP_PORT: "587"
          SMTP_SECURE: "false"
        run: |
          set -euo pipefail
          echo "ğŸ”§ terraform.tfvarsã‚’ç”Ÿæˆä¸­..."
          ./scripts/generate-tfvars.sh prod
          echo "âœ… terraform.tfvarsãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
      
      - name: Run Database Migration
        env:
          GCP_PROJECT_ID: portfolio-472821
        run: |
          set -euo pipefail
          echo "ğŸ”„ Running database migration (prod)..."
          
          # Cloud SQL Proxy ã‚’ä½¿ç”¨ã—ã¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          cd backend
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ã‚’å–å¾—
          DB_HOST=$(gcloud sql instances describe trip-shiori-prod-db-instance --format="value(ipAddresses[0].ipAddress)")
          DB_NAME="trip_shiori"
          DB_USER="trip_shiori_user"
          
          # ç’°å¢ƒå¤‰æ•°è¨­å®š
          export DATABASE_URL="postgresql://${DB_USER}:$(gcloud secrets versions access latest --secret=trip-shiori-prod-database-password)@${DB_HOST}:5432/${DB_NAME}?sslmode=require"
          
          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          npx prisma migrate deploy
          npx prisma generate
          
          echo "âœ… Database migration (prod) completed successfully"

      - name: Deploy to GCP Production
        env:
          GIT_SHA: ${{ github.sha }}
          GCP_PROJECT_ID: portfolio-472821
        run: |
          set -euo pipefail
          echo "Deploying to GCP Production..."
          echo "Branch: ${{ github.event.inputs.branch || github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "Tag: ${{ github.ref_name }}"
          
          # ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
          if [ -z "$GCP_PROJECT_ID" ]; then
            echo "âŒ GCP_PROJECT_ID is not set"
            exit 1
          fi
          
          # æœ¬ç•ªç’°å¢ƒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨
          make deploy-gcp-prod-auto
          
          echo "âœ… GCP Production deployment completed successfully"
      
      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          
          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®ç¢ºèª
          echo "Backend service status:"
          gcloud run services describe trip-shiori-prod-backend \
            --region=asia-northeast1 \
            --project=portfolio-472821 \
            --format="value(status.url,status.conditions[0].state)"
          
          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®ç¢ºèª
          echo "Frontend service status:"
          gcloud run services describe trip-shiori-prod-frontend \
            --region=asia-northeast1 \
            --project=portfolio-472821 \
            --format="value(status.url,status.conditions[0].state)"
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèª
          echo "Database status:"
          gcloud sql instances describe trip-shiori-prod-db-instance \
            --project=portfolio-472821 \
            --format="value(state)"
          
          echo "âœ… Deployment verification completed"
      
      - name: Post deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Deployment successful!"
            echo "Backend URL: https://api.trip.beita.dev"
            echo "Frontend URL: https://app.trip.beita.dev"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi
